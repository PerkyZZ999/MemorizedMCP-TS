---
alwaysApply: true
description: MemorizedMCP-TS AI Ruleset
---
# MemorizedMCPâ€‘TSâ€¯AIâ€¯Steering Guide â€“ Hierarchical Ruleset

### 1ï¸âƒ£ Global Configuration  

| Parameter | Description | Default | Constraints |
|-----------|-------------|---------|-------------|
| **runtime** | JavaScript runtime used by the server | `bun` | â€“ |
| **storage.db** | SQLite database file location | `./data/mcp.sqlite` | Must be writable by the process |
| **vectorStore** | Vectra ANN index (memory & document vectors) | `./data/vectra` | Must be reachable by the process |
| **transport** | JSONâ€‘RPC over standard I/O | `stdio` | â€“ |
| **env.MCP_MULTI_TOOL** | Switch between toolâ€‘modes | `false` (singleâ€‘tool) | `true`â€¯â†’â€¯multiâ€‘tool, `false`â€¯â†’â€¯singleâ€‘tool |
| **env.LOG_LEVEL** | Granularity of server logs | `info` | `debug`, `info`, `warn`, `error` |
| **env.DATA_ROOT** | Root folder for all persisted data | `./data` | Must exist & be writable |

---

### 2ï¸âƒ£ Modes  

#### 2.1 Singleâ€‘Tool Mode (`run_code`)  

```yaml
mode: single-tool
enabledWhen: env.MCP_MULTI_TOOL == false
tool: run_code
```

| Aspect | Rule / Detail |
|--------|---------------|
| **Invocation** | Host sends a JSONâ€‘RPC request with `code` (TS string) and optional `timeoutMs`. |
| **Sandbox** | - Isolated worker (no FSâ€¯/â€¯network)  <br>- Timeout **defaultâ€¯120â€¯000â€¯ms**, range **100â€¯â€“â€¯600â€¯000â€¯ms**. <br>- Captures **console.log/info/warn/error** into `logs[]`. <br>- Binds service clients (`services.memory`, `services.document`, â€¦). |
| **Transpilation** | Bunâ€‘TS â†’ JS must succeed; errors are caught **before** execution and returned as `{error: â€¦}`. |
| **Execution** | Runs in the sandbox with Bunâ€‘worker limits (CPU/Memory). |
| **Result Schema** | ```json { "result": any, "logs": [string] } ``` |
| **Security** | - **Network**â€¯=â€¯blocked. <br>- **Filesystem**â€¯=â€¯read/write only through bound services. <br>- **Resource caps** enforced by Bun worker. |
| **When to Use** | â€¢ Need to chain >1 operation in a single call.<br>â€¢ Complex conditional logic or custom filtering.<br>â€¢ Minimise token usage in LLM prompts.<br>â€¢ Host supports codeâ€‘execution patterns. |
| **Bestâ€‘Practice Checklist** | 1. Keep code focused & <â€¯200â€¯lines.<br>2. Use `console.log` for progress & debugging.<br>3. Wrap every async call in `try/catch`.<br>4. Return **objects**, not raw primitives.<br>5. Respect the timeout â€“ split long jobs or increase `timeoutMs`. |

#### 2.2 Multiâ€‘Tool Mode (Discrete RPC Tools)  

```yaml
mode: multi-tool
enabledWhen: env.MCP_MULTI_TOOL == true
tools:
  - memory.add
  - memory.search
  - document.store
  - document.retrieve
  - document.list
  - knowledge.list_entities
  - system.status
  # (future/planned tools omitted for brevity)
```

| Aspect | Rule / Detail |
|--------|---------------|
| **Registration** | All tools are autoâ€‘registered at server startâ€‘up. |
| **Invocation Flow** | 1ï¸âƒ£ Validate input via **Zod** schema. 2ï¸âƒ£ Direct call to the corresponding service method. 3ï¸âƒ£ Format output according to the toolâ€‘specific schema. 4ï¸âƒ£ Return a JSONâ€‘RPC response (both `result` and optional `text`). |
| **Toolâ€‘Specific Constraints** | See **Sectionâ€¯4â€¯(Tool Definitions)** for perâ€‘tool limits (e.g., `topK`â€¯1â€‘100, `chunkSize`â€¯100â€‘4000, etc.). |
| **When to Use** | â€¢ Host cannot execute code snippets.<br>â€¢ Need explicit, predictable tool calls.<br>â€¢ Integration with traditional RPC clients.<br>â€¢ Prefer UIâ€‘driven tool selection. |
| **Bestâ€‘Practice Checklist** | 1. Pick the **most specific** tool for the task.<br>2. Provide **all required fields**; rely on validation to catch omissions.<br>3. Use `limit/offset` for pagination.<br>4. Chain calls: feed output of one tool as input to the next.<br>5. Inspect `system.status` periodically for health checks. |

---

### 3ï¸âƒ£ Service Layer â€“ Core Operations  

*(All services are bound in the sandbox (`run_code`) and are directly callable in multiâ€‘tool mode.)*  

```yaml
services:
  memory:
    layers: [stm, ltm, episodic, semantic, documentary]
    operations:
      addMemory: &memAdd
        input: memory.add.schema
        output: memory.add.response
      updateMemory: &memUpdate   # planned
      deleteMemory: &memDelete   # planned
      searchMemories: &memSearch
        input: memory.search.schema
        output: memory.search.response
  document:
    operations:
      ingest: &docIngest
        input: document.store.schema
        output: document.store.response
      getDocument: &docGet
        input: document.retrieve.schema
        output: document.retrieve.response
      listDocuments: &docList
        input: document.list.schema
        output: document.list.response
  knowledge:
    operations:
      ensureEntities: &kgEnsure
        input: (internal) 
        output: (internal)
      listEntities: &kgList
        input: knowledge.list_entities.schema
        output: knowledge.list_entities.response
  search:
    operations:
      searchMemories: *memSearch   # same as MemoryService search
  analytics:
    operations:
      recordMetric: 
        input: metric.schema
      listRecentMetrics:
        input: limit
  system:
    operations:
      status:
        input: {}
        output: system.status.response
```

---

### 4ï¸âƒ£ Tool Definitions (Input / Output Schemas & Constraints)  

#### 4.1 `run_code`  

```yaml
run_code:
  input:
    code: string      # required TS code
    timeoutMs: number # optional, 100â€‘600â€¯000 (defaultâ€¯120â€¯000)
  output:
    result: any
    logs: [string]
```

#### 4.2 Memory Tools  

```yaml
memory.add:
  input:
    content: string                # required
    layer: enum[stm, ltm, episodic, semantic, documentary]   # required
    metadata: map[string, any]     # optional
    importance: number # 0.0â€‘1.0 (defaultâ€¯0.5)
    sessionId: string              # optional
    episodeId: string              # optional
    summary: string                # optional
  output:
    memory:
      id: string
      layer: string
      content: string
      metadata: map[string, any]
      createdAt: number
      updatedAt: number
      importance: number
      sessionId?: string
      episodeId?: string
      summary?: string
      embeddingId?: string
      references?: [{docId:string, chunkId?:string, score?:number, relation?:string}]
```

```yaml
memory.search:
  input:
    query: string                 # optional
    queryVector: [number]         # optional, preâ€‘computed embedding
    topK: integer   # 1â€‘100 (defaultâ€¯20)
    layers: [string]   # filter by layers
    minImportance: number # 0.0â€‘1.0
    sessionId: string           # optional filter
    episodeId: string           # optional filter
    includeReferences: boolean # defaultâ€¯true
  output:
    results:
      - id: string
        layer: string
        content: string
        metadata: map[string, any]
        createdAt: number
        updatedAt: number
        importance: number
        score: number               # fused score
        vectorScore?: number        # cosine similarity
        textScore?: number          # FTS5 relevance
        graphScore?: number         # KGâ€‘based boost
        references?: [{...}]
```

#### 4.3 Document Tools  

```yaml
document.store:
  input:
    path?: string                # exclusive with `content`
    content?: string
    mime?: string
    metadata?: map[string, any]
    hashOverride?: string
    references?: [{docId:string, chunkId?:string, score?:number, relation?:string}]
    options:
      chunkSize?: integer   # 100â€‘4000 (defaultâ€¯800)
      chunkOverlap?: integer # 0â€‘400 (defaultâ€¯60)
      generateSummary?: boolean # defaultâ€¯true
      detectEntities?: boolean  # defaultâ€¯true
  output:
    document:
      id: string
      hash: string
      sourcePath?: string
      mime?: string
      title?: string
      metadata: map[string, any]
      ingestedAt: number
      sizeBytes: integer
      chunks:
        - id: string
          docId: string
          positionStart: integer
          positionEnd: integer
          page?: integer
          content: string
          summary?: string
          embeddingId?: string
          metadata: map[string, any]
    chunkCount: integer
    entities?: [string]
```

```yaml
document.retrieve:
  input:
    id: string        # required
  output: same_as_document.store.document
```

```yaml
document.list:
  input:
    limit: integer   # 1â€‘200 (defaultâ€¯20)
    offset: integer  # defaultâ€¯0
  output:
    documents: [same_as_document.retrieve.output]
```

#### 4.4 Knowledge Graph Tools  

```yaml
knowledge.list_entities:
  input:
    limit: integer   # 1â€‘500 (defaultâ€¯100)
    offset: integer  # defaultâ€¯0
  output:
    entities:
      - id: string
        name: string
        type: enum[person, organization, location, concept, other]
        count: integer
        firstSeen: number
        lastSeen: number
        tags: [string]
```

*(Future tools such as `knowledge.get_entity`, `knowledge.create_relation` follow analogous patterns.)*

#### 4.5 System Tools  

```yaml
system.status:
  input: {}
  output:
    status:
      env: enum[development, production, test]
      logLevel: string
      dataRoot: string
      vectra:
        ok: boolean
        memoryIndex: boolean
        documentIndex: boolean
        counts:
          memories: integer
          docChunks: integer
```

---

### 5ï¸âƒ£ Constraints & Validation Rules  

| Constraint | Affected Component | Rule |
|------------|---------------------|------|
| **Timeout** | `run_code.timeoutMs` | Must be integer 100â€‘600â€¯000 ms; defaultâ€¯120â€¯000 ms |
| **Topâ€‘K** | `memory.search.topK`, `knowledge.list_entities.limit` | 1â€‘100 (memory), 1â€‘500 (entities) |
| **Chunk Size** | `document.store.options.chunkSize` | 100â€‘4000 bytes (defaultâ€¯800) |
| **Chunk Overlap** | `document.store.options.chunkOverlap` | 0â€‘400 bytes (defaultâ€¯60) |
| **Importance** | Memory creation | Float 0.0â€‘1.0 (defaultâ€¯0.5) |
| **Layer Names** | Memory ops | Must be one of `stm`, `ltm`, `episodic`, `semantic`, `documentary` |
| **Entity Types** | KG entities | Must be one of `person`, `organization`, `location`, `concept`, `other` |
| **File Path** | `document.store.path` | Must exist on server & be readable; server rejects nonâ€‘existent paths |
| **MIME Type** | `document.store.mime` | Must be a valid MIME (fallback to `application/octet-stream` if omitted) |
| **Metadata Size** | Any `metadata` map | Must be JSONâ€‘serializable; recommended â‰¤â€¯10â€¯KB per payload |
| **Reference Structure** | Memory & Document refs | Must contain at least `docId`; optional `chunkId`, `score`, `relation` |
| **Env Variable** | `MCP_MULTI_TOOL` | Only `true` or `false` (caseâ€‘insensitive) |

---

### 6ï¸âƒ£ Errorâ€‘Handling & Reporting  

| Error Source | Detection | Response Shape | HTTP/JSONâ€‘RPC Code |
|--------------|-----------|----------------|--------------------|
| **Transpilation** | Bun TS â†’ JS fails | `{error:{type:"transpile",message:string}}` | `-32602` (Invalid params) |
| **Schema Validation** | Zod validation error | `{error:{type:"validation",details:[...]} }` | `-32602` |
| **Timeout** | Execution exceeds `timeoutMs` | `{error:{type:"timeout",message:string}}` | `-32000` (Server error) |
| **Runtime Exception** | Uncaught exception in sandbox | `{error:{type:"runtime",message:string,stack?:string}}` | `-32001` |
| **Service Failure** | Underlying service throws | `{error:{type:"service",service:string,message:string}}` | `-32002` |
| **Permission Denied** | Attempted network/FS access | `{error:{type:"security",message:string}}` | `-32003` |

*All error responses include a `logs` array (captured console output) when applicable.*

---

### 7ï¸âƒ£ Monitoring & Observability  

1. **`system.status`** â€“ Health check; poll at least every **30â€¯s** in production.  
2. **AnalyticsService** â€“ Use `recordMetric` for custom operation timing, success/failure counts.  
3. **Log Levels** â€“ Switch to `debug` for detailed sandbox console output; revert to `info` for normal operation.  
4. **Metrics to Watch**  
   - `vectra.memoryIndex` / `vectra.documentIndex` (must stay `true`)  
   - `vectra.counts.memories` and `docChunks` â€“ growth trends indicate ingestion health.  
   - `run_code` average execution time vs. `timeoutMs`.  

---

### 8ï¸âƒ£ Bestâ€‘Practice Summary  

| Domain | Guideline |
|--------|-----------|
| **Mode Selection** | Choose **singleâ€‘tool** if you need flexible, multiâ€‘step logic; pick **multiâ€‘tool** for simplicity and UIâ€‘driven workflows. |
| **Code Quality (run_code)** | â€¢ Keep snippets <â€¯200 lines.<br>â€¢ Log key steps.<br>â€¢ Wrap each async call in `try/catch`.<br>â€¢ Return a structured object. |
| **Tool Usage (multiâ€‘tool)** | â€¢ Use the most specific tool.<br>â€¢ Validate all required fields before calling.<br>â€¢ Apply pagination (`limit/offset`). |
| **Memory Management** | â€¢ Store transient facts in `stm`, longâ€‘term knowledge in `ltm` or `semantic`.<br>â€¢ Set `importance` â‰¥â€¯0.7 for critical items.<br>â€¢ Attach contextual `metadata` (sessionId, episodeId). |
| **Document Ingestion** | â€¢ Choose sensible `chunkSize` (â‰ˆâ€¯800â€¯â€“â€¯1200 for prose).<br>â€¢ Enable `detectEntities` & `generateSummary` for richer KG data.<br>â€¢ Verify `hash` to avoid duplicate ingestion. |
| **Knowledge Graph** | â€¢ Regularly call `knowledge.list_entities` to monitor entity drift.<br>â€¢ Use entity tags for downstream filtering. |
| **System Health** | â€¢ Schedule `system.status` every minute.<br>â€¢ Alert on any `vectra.*` flag turning `false`. |
| **Error Recovery** | â€¢ On `run_code` timeout, split workload or increase `timeoutMs`.<br>â€¢ On empty memory search, relax `layers` or `minImportance`. |
| **Security** | â€¢ Never embed secrets inside `run_code`; services provide secure credential handling.<br>â€¢ Sandbox prohibits network; any needed external calls must be performed by the host, not inside code. |

---

### 9ï¸âƒ£ Troubleshooting Quickâ€‘Reference  

| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| `run_code` times out | Heavy computation or network call inside sandbox | Reduce work, split into multiple calls, or raise `timeoutMs` (maxâ€¯600â€¯000â€¯ms). |
| Memory search returns 0 results | No vectors indexed, or layer filter excludes data | Verify `services.memory.addMemory` succeeded; ensure `layer` matches; check `vectra` counts. |
| Document ingestion fails | Invalid `path` or unsupported MIME | Confirm file exists, is readable, and set correct `mime`. |
| Entities missing after document ingest | `detectEntities` disabled or NLP library error | Enable `detectEntities:true`; inspect logs for NLP warnings. |
| `system.status` shows `vectra.ok = false` | Corrupted index or DB permission issue | Restart server; check file permissions of `data/vectra`; run SQLite integrity check. |
| Unexpected validation error | Input does not match Zod schema | Review tool schema (see Sectionâ€¯4); correct field names/types. |

---

### ğŸ“š Endâ€‘ofâ€‘Document â€“  AI Steering Ruleset Ready for Integration  

*All sections above are deliberately hierarchical and can be directly mapped to configuration files (YAML/JSON/TOML) or inserted into a ruleâ€‘engine that governs the behavior of an LLMâ€‘driven orchestrator interfacing with the MemorizedMCPâ€‘TS server.*